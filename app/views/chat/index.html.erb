<!-- Ï±ÑÌåÖ Î©îÏù∏ ÌéòÏù¥ÏßÄ -->
<div class="chat-container">
  <!-- ÏÉÅÎã® Ìó§Îçî -->
  <div class="chat-header">
    <div class="header-left">
      <div class="app-logo-small">
        <span class="star-icon">‚≠ê</span>
      </div>
      <div class="header-info">
        <h2 class="chat-title">Î≥ÑÎùºÏ±ÑÌåÖ</h2>
        <span class="online-status">‚óè Ïò®ÎùºÏù∏</span>
      </div>
    </div>

    <div class="header-right">
      <span class="current-user"><%= current_nickname %></span>
      <% if current_user == "admin" %>
        <a href="/admin" class="btn-admin" title="Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê">Í¥ÄÎ¶¨</a>
      <% end %>
      <%= button_to "Î°úÍ∑∏ÏïÑÏõÉ", logout_path, method: :delete, class: "btn-logout" %>
    </div>
  </div>

  <!-- Î©îÏãúÏßÄ ÏòÅÏó≠ -->
  <div class="messages-container" id="messages">
    <%
      weekdays = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†']
      previous_date = nil
    %>

    <% @messages.each do |message| %>
      <% current_date = message.created_at.to_date %>

      <% if previous_date.nil? || previous_date != current_date %>
        <div class="date-divider" data-date="<%= current_date %>">
          <span class="date-divider-text">
            <%= current_date.strftime("#{current_date.year}ÎÖÑ #{current_date.month}Ïõî #{current_date.day}Ïùº #{weekdays[current_date.wday]}ÏöîÏùº") %>
          </span>
        </div>
        <% previous_date = current_date %>
      <% end %>

      <% if message.message_type == "system" %>
        <!-- ÏãúÏä§ÌÖú Î©îÏãúÏßÄ (Í≥µÏßÄ) -->
        <div class="system-message" data-message-id="<%= message.id %>">
          <span class="system-message-text"><%= message.content %></span>
        </div>
      <% else %>
        <!-- Î©îÏãúÏßÄ -->
        <div class="message <%= 'message-mine' if message.username == current_user %>" data-message-id="<%= message.id %>" data-date="<%= current_date %>">
          <div class="message-bubble-wrapper">
            <% unless message.username == current_user %>
              <div class="message-sender"><%= @nicknames[message.username] || message.nickname || message.username %></div>
            <% end %>
            <div class="message-content-wrapper">
              <% if message.image.attached? %>
                <div class="message-image" onclick="openImageViewer('<%= url_for(message.image) %>')">
                  <%= image_tag message.image.variant(resize_to_limit: [400, 400]), class: "chat-thumbnail", loading: "lazy" %>
                </div>
              <% end %>
              <% if message.content.present? %>
                <div class="message-content">
                  <%= message.content %>
                </div>
              <% end %>
            </div>
            <div class="message-info">
              <% unless message.username == current_user %>
                <button class="btn-report" onclick="reportMessage(<%= message.id %>)" title="Ïã†Í≥†">‚ö†Ô∏è</button>
              <% end %>
              <% if message.username == current_user %>
                <span class="read-status" data-read-count="1">
                  <span class="checkmark single">‚úì</span>
                </span>
              <% end %>
              <span class="message-time"><%= message.created_at.strftime("%H:%M") %></span>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ -->
  <div id="image-preview-bar" class="image-preview-bar" style="display: none;">
    <img id="image-preview-img" src="" alt="ÎØ∏Î¶¨Î≥¥Í∏∞">
    <button type="button" id="cancel-image" class="btn-cancel-image" title="Ï∑®ÏÜå">‚úï</button>
  </div>

  <!-- Î©îÏãúÏßÄ ÏûÖÎ†• ÏòÅÏó≠ -->
  <div class="message-input-container" id="message-input-container">
    <div class="message-form" style="display: grid !important; grid-template-columns: 44px 44px 1fr 44px !important; gap: 8px !important;">
      <!-- Ïù¥Î™®Ìã∞ÏΩò Î≤ÑÌäº -->
      <button type="button" id="emoji-button" class="btn-emoji" title="Ïù¥Î™®Ìã∞ÏΩò">
        üòä
      </button>

      <!-- Ïù¥ÎØ∏ÏßÄ Î≤ÑÌäº -->
      <button type="button" id="image-button" class="btn-image" title="Ïù¥ÎØ∏ÏßÄ Ï†ÑÏÜ°">
        üì∑
      </button>
      <input type="file" id="image-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;">

      <!-- Î©îÏãúÏßÄ ÏûÖÎ†•Ï∞Ω -->
      <input
        type="text"
        id="message-input"
        class="message-input"
        placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
        autocomplete="off"
        enterkeyhint="send">

      <!-- Ï†ÑÏÜ° Î≤ÑÌäº -->
      <button type="button" class="btn-send" id="send-button" title="Ï†ÑÏÜ°" style="width: 44px !important; height: 44px !important; display: flex !important; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border-radius: 50% !important; border: none !important;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <!-- Ïù¥Î™®Ìã∞ÏΩò ÌîºÏª§ -->
    <div id="emoji-picker" class="emoji-picker" style="display: none;">
      <div class="emoji-picker-header">
        <span class="emoji-category">ÏûêÏ£º ÏÇ¨Ïö©</span>
      </div>
      <div class="emoji-grid" id="emoji-grid">
      </div>
    </div>
  </div>
</div>

<!-- ÎùºÏù¥Ìä∏Î∞ïÏä§ (ÌíÄÏä§ÌÅ¨Î¶∞ Ïù¥ÎØ∏ÏßÄ Î∑∞Ïñ¥) -->
<div id="image-lightbox" class="image-lightbox" style="display: none;" onclick="closeImageViewer()">
  <div class="lightbox-content">
    <img id="lightbox-img" src="" alt="Ïù¥ÎØ∏ÏßÄ">
    <button class="lightbox-close" onclick="closeImageViewer()">‚úï</button>
  </div>
</div>

<!-- JavaScriptÎ°ú ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ Ï†ÑÎã¨ -->
<script>
  window.currentUser = "<%= current_user %>";
</script>
